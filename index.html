<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
  <title>Top 100 Exploration Projects</title>
  <link rel="stylesheet" href="https://js.arcgis.com/4.24/esri/themes/light/main.css">
  <script src="https://js.arcgis.com/4.24/"></script>
  <style>
    html,
    body,
    #viewDiv {
      padding: 0;
      margin: 0;
      height: 100%;
      width: 100%;
    }
  </style>
</head>
<body>
  <div id="viewDiv"></div>
  <script>
    require([
      "esri/Map",
      "esri/views/MapView",
      "esri/layers/FeatureLayer",
      "esri/widgets/Legend",
      "esri/widgets/LayerList",
      "esri/PopupTemplate",
      "esri/portal/Portal",
      "esri/portal/PortalItem",
      "esri/identity/IdentityManager"
    ], function(Map, MapView, FeatureLayer, Legend, LayerList, PopupTemplate, Portal, PortalItem, IdentityManager) {
      var map = new Map({
        basemap: "streets"
      });

      var view = new MapView({
        container: "viewDiv",
        map: map,
        center: [-98, 60],
        zoom: 3
      });

      // Add the layers from the provided URLs
      var layerUrls = [
        "https://maps-cartes.services.geo.ca/server_serveur/rest/services/NRCan/900A_and_top_100_en/MapServer/legend",
        "https://maps-cartes.services.geo.ca/server_serveur/rest/services/NRCan/900A_and_top_100_en/MapServer/layers",
        "https://maps-cartes.services.geo.ca/server_serveur/rest/services/NRCan/900A_and_top_100_en/MapServer/legend?dynamicLayers=%5B%5D&",
        "https://maps-cartes.services.geo.ca/server_serveur/rest/services/NRCan/900A_and_top_100_en/MapServer/layers?dynamicLayers=%5B%5D&",
        "https://maps-cartes.services.geo.ca/server_serveur/rest/services/NRCan/900A_and_top_100_en/MapServer/0",
        "https://maps-cartes.services.geo.ca/server_serveur/rest/services/NRCan/900A_and_top_100_en/MapServer/1",
        "https://maps-cartes.services.geo.ca/server_serveur/rest/services/NRCan/900A_and_top_100_en/MapServer/2",
        "https://maps-cartes.services.geo.ca/server_serveur/rest/services/NRCan/900A_and_top_100_en/MapServer/3",
        "https://maps-cartes.services.geo.ca/server_serveur/rest/services/NRCan/900A_and_top_100_en/MapServer/4",
        "https://maps-cartes.services.geo.ca/server_serveur/rest/services/NRCan/900A_and_top_100_en/MapServer/5",
        "https://maps-cartes.services.geo.ca/server_serveur/rest/services/NRCan/900A_and_top_100_en/MapServer/6",
        "https://maps-cartes.services.geo.ca/server_serveur/rest/services/NRCan/900A_and_top_100_en/MapServer/7",
        "https://maps-cartes.services.geo.ca/server_serveur/rest/services/NRCan/900A_and_top_100_en/MapServer/8",
        "https://maps-cartes.services.geo.ca/server_serveur/rest/services/NRCan/900A_and_top_100_en/MapServer/9",
        "https://maps-cartes.services.geo.ca/server_serveur/rest/services/NRCan/900A_and_top_100_en/MapServer/10",
        "https://maps-cartes.services.geo.ca/server_serveur/rest/services/NRCan/900A_and_top_100_en/MapServer/11",
        "https://maps-cartes.services.geo.ca/server_serveur/rest/services/NRCan/900A_and_top_100_en/MapServer/12"
      ];

      var layerPromises = layerUrls.map(function(url) {
        return new FeatureLayer({ url });
      });

      // A function to export the map to KML format
      function exportToKML() {
        var layersToExport = view.map.layers.toArray();
        var kml = '<?xml version="1.0" encoding="UTF-8"?>\n' +
          '<kml xmlns="http://www.opengis.net/kml/2.2">\n' +
          '<Document>\n';

        layersToExport.forEach(function(layer) {
          kml += '<Folder>\n';
          kml += '<name>' + layer.title + '</name>\n';

          if (layer.sublayers && layer.sublayers.length > 0) {
            layer.sublayers.forEach(function(sublayer) {
              kml += '<Placemark>\n';
              kml += '<name>' + sublayer.title + '</name>\n';
              kml += '<description><![CDATA[' + sublayer.description + ']]></description>\n';
              kml += '</Placemark>\n';
            });
          }

          kml += '</Folder>\n';
        });

        kml += '</Document>\n</kml>';

        // Create a Blob containing the KML data
        var blob = new Blob([kml], { type: 'application/vnd.google-earth.kml+xml' });

        // Create a download link for the KML file
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url;
        a.download = 'map.kml';
        document.body.appendChild(a);

        // Programmatically click the link to trigger the download
        a.click();

        // Clean up by removing the link and revoking the object URL
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      // Create a button for exporting the map to KML
      var exportButton = document.createElement("button");
      exportButton.textContent = "Export to KML";
      exportButton.addEventListener("click", exportToKML);
      view.ui.add(exportButton, "top-left");

      Promise.all(layerPromises).then(function(layers) {
        // Create a new array with custom layer order
        var customLayerOrder = [
          "Top 100 Exploration Projects (0)",
          "900A (1)",
          "Oil and Gas (2)",
          "Producing Mines (3)",
          "Metal mines (4)",
          "Nonmetal mines (5)",
          "Coal mines (6)",
          "Oil sands mines (7)",
          "Metallurgical Works (8)",
          "Smelters and refineries (9)",
          "Steel mills (10)",
          "Ferroalloy plants (11)",
          "Automobile shredders (12)"
        ];

        // Sort layers based on custom order
        layers.sort(function (a, b) {
          return customLayerOrder.indexOf(a.title) - customLayerOrder.indexOf(b.title);
        });

        map.addMany(layers);
      });

      // Create a LayerList widget to display the layers
      var layerList = new LayerList({
        view: view,
        listItemCreatedFunction: function(event) {
          // Display the layer names and descriptions in the LayerList
          var item = event.item;
          var layer = item.layer;

          item.title = layer.title;
          item.description = layer.description || "No description available.";
        }
      });

      view.ui.add(layerList, "top-right");

      // Add an event handler for the pointer-move event to display layer names and descriptions
      view.on("pointer-move", function(event) {
        view.hitTest(event).then(function(response) {
          if (response.results.length > 0) {
            var feature = response.results[0].graphic;
            var layerName = feature.layer.title;
            var description = feature.layer.description || "No description available.";

            view.popup.open({
              title: layerName,
              content: description,
              location: event.mapPoint
            });
          } else {
            view.popup.close();
          }
        });
      });
    });
  </script>
</body>
</html>
